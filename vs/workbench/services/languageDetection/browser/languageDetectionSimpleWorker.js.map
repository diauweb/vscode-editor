{"version":3,"sources":["out-vscode/vs/workbench/services/languageDetection/browser/fake","out-vscode/vs/workbench/services/languageDetection/browser/file:/home/runner/work/vscode-editor/vscode-editor/vscode/src/vs/workbench/services/languageDetection/browser/languageDetectionSimpleWorker.ts"],"sourcesContent":["}).call(this);","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { ModelOperations, ModelResult } from '@vscode/vscode-languagedetection';\nimport { StopWatch } from 'vs/base/common/stopwatch';\nimport { IRequestHandler } from 'vs/base/common/worker/simpleWorker';\nimport { EditorSimpleWorker } from 'vs/editor/common/services/editorSimpleWorker';\nimport { EditorWorkerHost } from 'vs/editor/common/services/editorWorkerServiceImpl';\n\n/**\n * Called on the worker side\n * @internal\n */\nexport function create(host: EditorWorkerHost): IRequestHandler {\n\treturn new LanguageDetectionSimpleWorker(host, null);\n}\n\n/**\n * @internal\n */\nexport class LanguageDetectionSimpleWorker extends EditorSimpleWorker {\n\tprivate static readonly expectedRelativeConfidence = 0.2;\n\tprivate static readonly positiveConfidenceCorrectionBucket1 = 0.05;\n\tprivate static readonly positiveConfidenceCorrectionBucket2 = 0.025;\n\tprivate static readonly negativeConfidenceCorrection = 0.5;\n\n\tprivate _modelOperations: ModelOperations | undefined;\n\tprivate _loadFailed: boolean = false;\n\n\tpublic async detectLanguage(uri: string): Promise<string | undefined> {\n\t\tconst languages: string[] = [];\n\t\tconst confidences: number[] = [];\n\t\tconst stopWatch = new StopWatch(true);\n\t\tfor await (const language of this.detectLanguagesImpl(uri)) {\n\t\t\tlanguages.push(language.languageId);\n\t\t\tconfidences.push(language.confidence);\n\t\t}\n\t\tstopWatch.stop();\n\n\t\tif (languages.length) {\n\t\t\tthis._host.fhr('sendTelemetryEvent', [languages, confidences, stopWatch.elapsed()]);\n\t\t\treturn languages[0];\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate async getModelOperations(): Promise<ModelOperations> {\n\t\tif (this._modelOperations) {\n\t\t\treturn this._modelOperations;\n\t\t}\n\n\t\tconst uri: string = await this._host.fhr('getIndexJsUri', []);\n\t\tconst { ModelOperations } = await import(uri) as typeof import('@vscode/vscode-languagedetection');\n\t\tthis._modelOperations = new ModelOperations({\n\t\t\tmodelJsonLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.fhr('getModelJsonUri', []));\n\t\t\t\ttry {\n\t\t\t\t\tconst modelJSON = await response.json();\n\t\t\t\t\treturn modelJSON;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconst message = `Failed to parse model JSON.`;\n\t\t\t\t\tthrow new Error(message);\n\t\t\t\t}\n\t\t\t},\n\t\t\tweightsLoaderFunc: async () => {\n\t\t\t\tconst response = await fetch(await this._host.fhr('getWeightsUri', []));\n\t\t\t\tconst buffer = await response.arrayBuffer();\n\t\t\t\treturn buffer;\n\t\t\t}\n\t\t});\n\n\t\treturn this._modelOperations!;\n\t}\n\n\t// This adjusts the language confidence scores to be more accurate based on:\n\t// * VS Code's language usage\n\t// * Languages with 'problematic' syntaxes that have caused incorrect language detection\n\tprivate adjustLanguageConfidence(modelResult: ModelResult): ModelResult {\n\t\tswitch (modelResult.languageId) {\n\t\t\t// For the following languages, we increase the confidence because\n\t\t\t// these are commonly used languages in VS Code and supported\n\t\t\t// by the model.\n\t\t\tcase 'javascript':\n\t\t\tcase 'html':\n\t\t\tcase 'json':\n\t\t\tcase 'typescript':\n\t\t\tcase 'css':\n\t\t\tcase 'python':\n\t\t\tcase 'xml':\n\t\t\tcase 'php':\n\t\t\t\tmodelResult.confidence += LanguageDetectionSimpleWorker.positiveConfidenceCorrectionBucket1;\n\t\t\t\tbreak;\n\t\t\t// case 'yaml': // YAML has been know to cause incorrect language detection because the language is pretty simple. We don't want to increase the confidence for this.\n\t\t\tcase 'cpp':\n\t\t\tcase 'shellscript':\n\t\t\tcase 'java':\n\t\t\tcase 'csharp':\n\t\t\tcase 'c':\n\t\t\t\tmodelResult.confidence += LanguageDetectionSimpleWorker.positiveConfidenceCorrectionBucket2;\n\t\t\t\tbreak;\n\n\t\t\t// For the following languages, we need to be extra confident that the language is correct because\n\t\t\t// we've had issues like #131912 that caused incorrect guesses. To enforce this, we subtract the\n\t\t\t// negativeConfidenceCorrection from the confidence.\n\n\t\t\t// languages that are provided by default in VS Code\n\t\t\tcase 'bat':\n\t\t\tcase 'ini':\n\t\t\tcase 'makefile':\n\t\t\tcase 'sql':\n\t\t\t// languages that aren't provided by default in VS Code\n\t\t\tcase 'csv':\n\t\t\tcase 'toml':\n\t\t\t\t// Other considerations for negativeConfidenceCorrection that\n\t\t\t\t// aren't built in but suported by the model include:\n\t\t\t\t// * Assembly, TeX - These languages didn't have clear language modes in the community\n\t\t\t\t// * Markdown, Dockerfile - These languages are simple but they embed other languages\n\t\t\t\tmodelResult.confidence -= LanguageDetectionSimpleWorker.negativeConfidenceCorrection;\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tbreak;\n\n\t\t}\n\t\treturn modelResult;\n\t}\n\n\tprivate async * detectLanguagesImpl(uri: string): AsyncGenerator<ModelResult, void, unknown> {\n\t\tif (this._loadFailed) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelOperations: ModelOperations | undefined;\n\t\ttry {\n\t\t\tmodelOperations = await this.getModelOperations();\n\t\t} catch (e) {\n\t\t\tconsole.log(e);\n\t\t\tthis._loadFailed = true;\n\t\t\treturn;\n\t\t}\n\n\t\tconst model = this._getModel(uri);\n\t\tif (!model) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet modelResults: ModelResult[] | undefined;\n\t\t// Grab the first 10000 characters\n\t\tconst end = model.positionAt(10000);\n\t\tconst content = model.getValueInRange({\n\t\t\tstartColumn: 1,\n\t\t\tstartLineNumber: 1,\n\t\t\tendColumn: end.column,\n\t\t\tendLineNumber: end.lineNumber\n\t\t});\n\t\ttry {\n\t\t\tmodelResults = await modelOperations.runModel(content);\n\t\t} catch (e) {\n\t\t\tconsole.warn(e);\n\t\t}\n\n\t\tif (!modelResults\n\t\t\t|| modelResults.length === 0\n\t\t\t|| modelResults[0].confidence < LanguageDetectionSimpleWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst firstModelResult = this.adjustLanguageConfidence(modelResults[0]);\n\t\tif (firstModelResult.confidence < LanguageDetectionSimpleWorker.expectedRelativeConfidence) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst possibleLanguages: ModelResult[] = [firstModelResult];\n\n\t\tfor (let current of modelResults) {\n\t\t\tif (current === firstModelResult) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcurrent = this.adjustLanguageConfidence(current);\n\t\t\tconst currentHighest = possibleLanguages[possibleLanguages.length - 1];\n\n\t\t\tif (currentHighest.confidence - current.confidence >= LanguageDetectionSimpleWorker.expectedRelativeConfidence) {\n\t\t\t\twhile (possibleLanguages.length) {\n\t\t\t\t\tyield possibleLanguages.shift()!;\n\t\t\t\t}\n\t\t\t\tif (current.confidence > LanguageDetectionSimpleWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tif (current.confidence > LanguageDetectionSimpleWorker.expectedRelativeConfidence) {\n\t\t\t\t\tpossibleLanguages.push(current);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n}\n"],"mappings":"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","names":[],"file":"languageDetectionSimpleWorker.js"}